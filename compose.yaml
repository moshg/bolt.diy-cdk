services:
  bolt-diy:
    image: ghcr.io/stackblitz-labs/bolt.diy:6a8449e
    environment:
      - NODE_ENV=production
      - PORT=5173
      - RUNNING_IN_DOCKER=true
  auth-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.8.1
    ports:
      - "4180:4180"
    environment:
      # ref. https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview
      # ref. https://github.com/bitly/oauth2_proxy/issues/674
      - OAUTH2_PROXY_HTTP_ADDRESS=http://0.0.0.0:4180
      - OAUTH2_PROXY_UPSTREAMS=http://bolt-diy:5173
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_SCOPE=openid
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_PROVIDER_DISPLAY_NAME="AWS Cognito"
      - OAUTH2_PROXY_CLIENT_ID=${COGNITO_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${COGNITO_CLIENT_SECRET}
      - OAUTH2_PROXY_COOKIE_SECURE=false
      # Generated by `openssl rand -base64 32 | tr '+/' '-_' | tr -d '='`
      - OAUTH2_PROXY_COOKIE_SECRET=3RLUho8lKWNSeuvl-RfUtUZRPRuPRA1tZZiLM76IWbs
      - OAUTH2_PROXY_SESSION_COOKIE_MINIMAL=true
      # NOTE: You need to add this REDIRECT_URL to the "Allowed callback URLs" in the App client settings of AWS Cognito.
      # Also, you need to add the signout url "http://localhost:4180/oauth2/sign_out" to the "Allowed sign-out URLs".
      - OAUTH2_PROXY_REDIRECT_URL=http://localhost:4180/oauth2/callback
      - OAUTH2_PROXY_OIDC_ISSUER_URL=https://cognito-idp.${AWS_REGION}.amazonaws.com/${COGNITO_USER_POOL_ID}
      - OAUTH2_PROXY_LOGIN_URL="https://${COGNITO_LOGIN_SUBDOMAIN}.auth.${AWS_REGION}.amazoncognito.com/oauth2/authorize"
      - OAUTH2_PROXY_PROFILE_URL="https://${COGNITO_LOGIN_SUBDOMAIN}.auth.${AWS_REGION}.amazoncognito.com/oauth2/userInfo"
      - OAUTH2_PROXY_REDEEM_URL="https://${COGNITO_LOGIN_SUBDOMAIN}.auth.${AWS_REGION}.amazoncognito.com/oauth2/token"
